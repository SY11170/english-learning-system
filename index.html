<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Lab - 進階英文學習系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State & Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'english-learning-v9';

        let currentUser = null;
        let wordList = [];
        let activeTab = 'input';
        let currentQuiz = null;
        let selectedChoices = [];
        let quizFeedback = null;
        let quizMode = 'en-to-zh';
        let editingId = null;

        // --- DOM Elements ---
        const tabInput = document.getElementById('tab-input');
        const tabList = document.getElementById('tab-list');
        const tabQuiz = document.getElementById('tab-quiz');
        
        const navBtns = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.section');

        // --- Auth Initialization ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                startListeningToWords();
            }
        });

        // --- Firestore Listeners ---
        const startListeningToWords = () => {
            const wordCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'words');
            onSnapshot(wordCol, (snapshot) => {
                wordList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWordList();
                updateStats();
            });
        };

        // --- Core Functions ---
        window.switchTab = (tabName) => {
            activeTab = tabName;
            sections.forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            
            navBtns.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-slate-400');
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('text-slate-400');
                }
            });

            if(tabName === 'quiz') startChoiceQuiz();
        };

        window.playAudio = (text) => {
            if (!text) return;
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&total=1&idx=0&textlen=${text.length}&client=tw-ob&prev=input`;
            new Audio(url).play();
        };

        // --- Word Management ---
        const meaningsContainer = document.getElementById('meanings-container');
        window.addMeaningField = (value = '') => {
            const div = document.createElement('div');
            div.className = "flex gap-2 meaning-field animate-in fade-in zoom-in-95";
            div.innerHTML = `
                <input type="text" value="${value}" class="meaning-input flex-1 bg-slate-50 rounded-xl px-4 py-2.5 outline-none" placeholder="輸入中文含義...">
                <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            meaningsContainer.appendChild(div);
            lucide.createIcons();
        };

        window.saveWord = async () => {
            const word = document.getElementById('input-word').value.trim().toLowerCase();
            const pos = document.getElementById('input-pos').value;
            const mInputs = document.querySelectorAll('.meaning-input');
            const meanings = Array.from(mInputs).map(i => i.value.trim()).filter(v => v !== '');

            if (!word || meanings.length === 0 || !currentUser) return;

            const wordCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'words');
            await addDoc(wordCol, {
                word, meanings, pos,
                wrongCount: 0, quizCount: 0, createdAt: Date.now()
            });

            document.getElementById('input-word').value = '';
            meaningsContainer.innerHTML = '';
            addMeaningField();
            switchTab('list');
        };

        window.handleAutoTranslate = async () => {
            const word = document.getElementById('input-word').value;
            if (!word) return;
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-TW&dt=t&q=${encodeURIComponent(word)}`);
                const data = await res.json();
                meaningsContainer.innerHTML = '';
                addMeaningField(data[0][0][0]);
            } catch(e) { console.error(e); }
        };

        const renderWordList = () => {
            const container = document.getElementById('word-list-container');
            const search = document.getElementById('search-box').value.toLowerCase();
            container.innerHTML = '';

            wordList.filter(w => w.word.includes(search) || w.meanings.some(m => m.includes(search)))
            .forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-sm">${item.word}</span>
                            <span class="text-[9px] font-bold bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded uppercase">${item.pos}</span>
                            <button onclick="playAudio('${item.word}')" class="text-slate-300 hover:text-indigo-500"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div class="text-[11px] text-slate-500 truncate mt-0.5">${item.meanings.join(', ')}</div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="deleteWord('${item.id}')" class="p-2 text-slate-300 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        };

        window.deleteWord = async (id) => {
            if(confirm("確定刪除？")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'words', id));
            }
        };

        // --- Quiz Engine ---
        window.startChoiceQuiz = async () => {
            if (wordList.length < 4) {
                alert("請先加入至少 4 個單字");
                switchTab('input');
                return;
            }

            const minCount = Math.min(...wordList.map(w => w.quizCount || 0));
            const pool = wordList.filter(w => (w.quizCount || 0) <= minCount);
            const weighted = [];
            pool.forEach(w => {
                for(let i=0; i < (w.wrongCount || 0) + 1; i++) weighted.push(w);
            });
            const selected = weighted[Math.floor(Math.random() * weighted.length)];
            
            quizMode = Math.random() > 0.5 ? 'en-to-zh' : 'zh-to-en';
            currentQuiz = selected;
            selectedChoices = [];
            quizFeedback = null;

            let options = [];
            if (quizMode === 'en-to-zh') {
                const correct = selected.meanings.map(m => ({ text: m, isCorrect: true }));
                const wrong = wordList
                    .filter(w => w.word !== selected.word)
                    .flatMap(w => w.meanings)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 5)
                    .map(m => ({ text: m, isCorrect: false }));
                options = [...correct, ...wrong].sort(() => Math.random() - 0.5);
            } else {
                options = [{ text: selected.word, isCorrect: true }];
                const used = new Set([selected.word]);
                const candidates = [...wordList].sort(() => Math.random() - 0.5);
                for(let w of candidates) {
                    if(!used.has(w.word)) {
                        options.push({ text: w.word, isCorrect: false });
                        used.add(w.word);
                    }
                    if(options.length >= 4) break;
                }
                options.sort(() => Math.random() - 0.5);
            }
            currentQuiz.options = options;
            renderQuiz();

            if (currentUser) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'words', selected.id), {
                    quizCount: (selected.quizCount || 0) + 1
                });
            }
        };

        const renderQuiz = () => {
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <div class="text-center mb-6">
                    <span class="px-3 py-0.5 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 inline-block shadow-sm">詞性：${currentQuiz.pos}</span>
                    <h2 class="text-3xl font-black text-slate-900 tracking-tight mt-1">${quizMode === 'en-to-zh' ? currentQuiz.word : currentQuiz.meanings[0]}</h2>
                    <p class="text-[9px] text-slate-400 mt-2 font-bold uppercase tracking-tighter">
                        ${quizMode === 'en-to-zh' && currentQuiz.meanings.length > 1 ? '多選題：請選齊所有含義' : '單選題：請選擇正確答案'}
                    </p>
                </div>
                <div class="grid gap-2 max-w-xs mx-auto" id="options-box"></div>
                <div id="quiz-footer" class="mt-4 max-w-xs mx-auto"></div>
            `;

            const optBox = document.getElementById('options-box');
            currentQuiz.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `w-full px-4 py-3 rounded-xl text-left font-bold text-sm transition-all border flex items-center gap-3 bg-white text-slate-700 border-slate-100 hover:border-indigo-500`;
                btn.innerHTML = `
                    <div class="icon-slot">${currentQuiz.meanings.length > 1 && quizMode === 'en-to-zh' ? '<i data-lucide="square" class="w-4 h-4 text-slate-300"></i>' : (idx+1)}</div>
                    <span class="truncate">${opt.text}</span>
                `;
                btn.onclick = () => toggleOption(opt.text, btn);
                optBox.appendChild(btn);
            });
            
            document.getElementById('quiz-footer').innerHTML = `
                <button onclick="submitQuiz()" id="submit-btn" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black hover:bg-indigo-600 transition shadow-md disabled:opacity-50 uppercase text-xs tracking-wider" disabled>確認提交</button>
            `;
            lucide.createIcons();
        };

        window.toggleOption = (text, btn) => {
            if(quizFeedback) return;
            const idx = selectedChoices.indexOf(text);
            if(idx > -1) {
                selectedChoices.splice(idx, 1);
                btn.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'ring-1', 'ring-indigo-500');
                if(currentQuiz.meanings.length > 1 && quizMode === 'en-to-zh') btn.querySelector('.icon-slot').innerHTML = '<i data-lucide="square" class="w-4 h-4 text-slate-300"></i>';
            } else {
                // 如果是單選模式，先清除其他選項
                if(!(currentQuiz.meanings.length > 1 && quizMode === 'en-to-zh')) {
                    selectedChoices = [];
                    document.querySelectorAll('#options-box button').forEach(b => b.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'ring-1', 'ring-indigo-500'));
                }
                selectedChoices.push(text);
                btn.classList.add('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'ring-1', 'ring-indigo-500');
                if(currentQuiz.meanings.length > 1 && quizMode === 'en-to-zh') btn.querySelector('.icon-slot').innerHTML = '<i data-lucide="check-square" class="w-4 h-4 text-indigo-500"></i>';
            }
            document.getElementById('submit-btn').disabled = selectedChoices.length === 0;
            lucide.createIcons();
        };

        window.submitQuiz = async () => {
            const corrects = currentQuiz.options.filter(o => o.isCorrect).map(o => o.text);
            const selCorrect = selectedChoices.filter(c => corrects.includes(c));
            const selWrong = selectedChoices.filter(c => !corrects.includes(c));

            const perfect = selCorrect.length === corrects.length && selWrong.length === 0;
            const partial = selCorrect.length > 0 && selCorrect.length < corrects.length && selWrong.length === 0;
            
            quizFeedback = { perfect, partial, missing: corrects.length - selCorrect.length };

            // Update UI
            document.querySelectorAll('#options-box button').forEach(btn => {
                const text = btn.querySelector('span').innerText;
                const isCorrect = corrects.includes(text);
                const isSelected = selectedChoices.includes(text);
                
                btn.classList.remove('bg-indigo-50', 'text-indigo-700', 'border-indigo-500', 'ring-1', 'ring-indigo-500');
                if(isCorrect) {
                    btn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500', 'scale-[1.02]');
                } else if(isSelected) {
                    btn.classList.add('bg-rose-500', 'text-white', 'border-rose-500', 'opacity-90');
                } else {
                    btn.classList.add('opacity-40');
                }
            });

            const footer = document.getElementById('quiz-footer');
            footer.innerHTML = `
                <div class="text-center animate-in fade-in zoom-in-95 mt-4">
                    <div class="text-sm font-black mb-4 flex flex-col items-center ${perfect ? 'text-emerald-600' : 'text-rose-600'}">
                        ${perfect ? '完全正確！Perfect match!' : (partial ? <span class="text-amber-600">未選齊 (漏了 ${quizFeedback.missing} 個)</span> : '不正確')}
                        ${!perfect ? <p class="text-[10px] text-slate-400 mt-1 uppercase">正確含義：${currentQuiz.meanings.join(', ')}</p> : ''}
                    </div>
                    <button onclick="startChoiceQuiz()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black shadow-md uppercase">Next Question</button>
                </div>
            `;

            if(!perfect && currentUser) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'words', currentQuiz.id), {
                    wrongCount: (currentQuiz.wrongCount || 0) + 1
                });
            }
        };

        const updateStats = () => {
            document.getElementById('stat-count').innerText = `WORDS: ${wordList.length}`;
        };

        // Initialize
        window.onload = () => {
            initAuth();
            addMeaningField();
            lucide.createIcons();
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn { transition: all 0.2s; }
        input, select { -webkit-appearance: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- Navigation -->
    <nav class="bg-white border-b sticky top-0 z-20 shadow-sm">
        <div class="max-w-xl mx-auto px-4 h-14 flex justify-between items-center">
            <div class="flex items-center gap-1 font-black text-indigo-600 text-sm md:text-base">
                <i data-lucide="book-open" class="w-4 h-4"></i> <span class="uppercase tracking-tighter">Eng Lab</span>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="switchTab('input')" data-tab="input" class="nav-btn p-2 rounded-lg bg-indigo-600 text-white">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
                <button onclick="switchTab('list')" data-tab="list" class="nav-btn p-2 rounded-lg text-slate-400 hover:bg-slate-100">
                    <i data-lucide="layout-grid" class="w-4 h-4"></i>
                </button>
                <div class="w-px h-6 bg-slate-200 mx-1"></div>
                <button onclick="switchTab('quiz')" data-tab="quiz" class="nav-btn p-2 rounded-lg text-slate-400 hover:bg-slate-100">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-3">
        
        <!-- Input Section -->
        <div id="section-input" class="section space-y-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 animate-in">
                <h2 class="text-xs font-bold mb-4 text-slate-500 uppercase tracking-widest">Add New Word</h2>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <input type="text" id="input-word" class="flex-1 bg-slate-50 rounded-xl px-4 py-2.5 outline-none focus:ring-2 focus:ring-indigo-500 font-bold" placeholder="輸入單字...">
                        <button onclick="handleAutoTranslate()" class="text-[10px] font-black text-indigo-600 bg-indigo-50 px-3 rounded-xl uppercase">Auto</button>
                        <button onclick="playAudio(document.getElementById('input-word').value)" class="p-2.5 bg-slate-100 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition">
                            <i data-lucide="volume-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="meanings-container" class="space-y-2">
                        <!-- Meaning inputs will be added here -->
                    </div>
                    <div class="flex justify-between items-center px-1">
                        <button onclick="addMeaningField()" class="text-xs font-bold text-indigo-600 flex items-center gap-1 hover:underline">
                            <i data-lucide="plus" class="w-3 h-3"></i> 新增含義
                        </button>
                        <select id="input-pos" class="text-xs bg-transparent font-bold text-slate-400 outline-none cursor-pointer">
                            <option value="n.">n.</option>
                            <option value="v.">v.</option>
                            <option value="adj.">adj.</option>
                            <option value="adv.">adv.</option>
                            <option value="phr.">phr.</option>
                        </select>
                    </div>
                    <button onclick="saveWord()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black hover:bg-indigo-600 transition shadow-md uppercase text-xs tracking-widest">Save to Library</button>
                </div>
            </div>
        </div>

        <!-- List Section -->
        <div id="section-list" class="section hidden space-y-3 animate-in">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-3 text-slate-400 w-4 h-4"></i>
                <input type="text" id="search-box" oninput="renderWordList()" placeholder="搜尋單字或解釋..." class="w-full pl-10 pr-4 py-2.5 bg-white rounded-xl border border-slate-100 shadow-sm outline-none text-sm focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="word-list-container" class="grid gap-2 overflow-y-auto max-h-[calc(100vh-160px)] pr-1">
                <!-- Word items will be injected here -->
            </div>
        </div>

        <!-- Quiz Section -->
        <div id="section-quiz" class="section hidden animate-in">
            <div id="quiz-container" class="p-6 rounded-3xl bg-white border border-slate-100 shadow-sm">
                <!-- Quiz content will be injected here -->
            </div>
        </div>

    </main>

    <!-- Floating Badge -->
    <div class="fixed bottom-4 right-4 flex">
        <div id="stat-count" class="bg-white/80 backdrop-blur-md px-3 py-1.5 rounded-full shadow-lg border border-slate-200 text-[9px] font-black text-slate-500 flex items-center gap-2 uppercase tracking-tighter">
            WORDS: 0
        </div>
    </div>

</body>
</html>
