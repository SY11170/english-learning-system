<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Lab - 進階英文學習系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State & Firebase Config
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'english-learning-v9';

        let currentUser = null;
        let wordList = [];
        let activeTab = 'input';
        let currentQuiz = null;
        let selectedChoices = [];
        let quizFeedback = null;
        let quizMode = 'en-to-zh';
        let editingId = null;

        // --- DOM Elements ---
        const tabInput = document.getElementById('tab-input');
        const tabList = document.getElementById('tab-list');
        const tabQuiz = document.getElementById('tab-quiz');
        
        const navBtns = document.querySelectorAll('.nav-btn');
        const sections = document.querySelectorAll('.section');

        // --- Auth Initialization ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                startListeningToWords();
            }
        });

        // --- Firestore Listeners ---
        const startListeningToWords = () => {
            const wordCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'words');
            onSnapshot(wordCol, (snapshot) => {
                wordList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderWordList();
                updateStats();
            });
        };

        // --- Core Functions ---
        window.switchTab = (tabName) => {
            activeTab = tabName;
            sections.forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            
            navBtns.forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('text-slate-400');
                if(btn.dataset.tab === tabName) {
                    btn.classList.add('bg-indigo-600', 'text-white');
                    btn.classList.remove('text-slate-400');
                }
            });

            if(tabName === 'quiz') startChoiceQuiz();
        };

        window.playAudio = (text) => {
            if (!text) return;
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&total=1&idx=0&textlen=${text.length}&client=tw-ob&prev=input`;
            new Audio(url).play();
        };

        // --- Word Management ---
        const meaningsContainer = document.getElementById('meanings-container');
        window.addMeaningField = (value = '') => {
            const div = document.createElement('div');
            div.className = "flex gap-2 meaning-field animate-in fade-in zoom-in-95";
            div.innerHTML = `
                <input type="text" value="${value}" class="meaning-input flex-1 bg-slate-50 rounded-xl px-4 py-2.5 outline-none" placeholder="輸入中文含義...">
                <button onclick="this.parentElement.remove()" class="text-slate-300 hover:text-rose-500"><i data-lucide="x" class="w-4 h-4"></i></button>
            `;
            meaningsContainer.appendChild(div);
            lucide.createIcons();
        };

        window.saveWord = async () => {
            const word = document.getElementById('input-word').value.trim().toLowerCase();
            const pos = document.getElementById('input-pos').value;
            const mInputs = document.querySelectorAll('.meaning-input');
            const meanings = Array.from(mInputs).map(i => i.value.trim()).filter(v => v !== '');

            if (!word || meanings.length === 0 || !currentUser) return;

            const wordCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'words');
            await addDoc(wordCol, {
                word, meanings, pos,
                wrongCount: 0, quizCount: 0, createdAt: Date.now()
            });

            document.getElementById('input-word').value = '';
            meaningsContainer.innerHTML = '';
            addMeaningField();
            switchTab('list');
        };

        window.handleAutoTranslate = async () => {
            const word = document.getElementById('input-word').value;
            if (!word) return;
            try {
                const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-TW&dt=t&q=${encodeURIComponent(word)}`);
                const data = await res.json();
                meaningsContainer.innerHTML = '';
                addMeaningField(data[0][0][0]);
            } catch(e) { console.error(e); }
        };

        const renderWordList = () => {
            const container = document.getElementById('word-list-container');
            const search = document.getElementById('search-box').value.toLowerCase();
            container.innerHTML = '';

            wordList.filter(w => w.word.includes(search) || w.meanings.some(m => m.includes(search)))
            .forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-black text-sm">${item.word}</span>
                            <span class="text-[9px] font-bold bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded uppercase">${item.pos}</span>
                            <button onclick="playAudio('${item.word}')" class="text-slate-300 hover:text-indigo-500"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                        <div class="text-[11px] text-slate-500 truncate mt-0.5">${item.meanings.join(', ')}</div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="deleteWord('${item.id}')" class="p-2 text-slate-300 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        };

        window.deleteWord = async (id) => {
            if(confirm("確定刪除？")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'words', id));
            }
        };

        // --- Quiz Engine ---
        window.startChoiceQuiz = async () => {
            if (wordList.length < 4) {
                alert("請先加入至少 4 個單字");
                switchTab('input');
                return;
            }

            const minCount = Math.min(...wordList.map(w => w.quizCount || 0));
            const pool = wordList.filter(w => (w.quizCount || 0) <= minCount);
            const weighted = [];
            pool.forEach(w => {
                for(let i=0; i < (w.wrongCount || 0) + 1; i++) weighted.push(w);
            });
            const selected = weighted[Math.floor(Math.random() * weighted.length)];
            
            quizMode = Math.random() > 0.5 ? 'en-to-zh' : 'zh-to-en';
            currentQuiz = selected;
            selectedChoices = [];
            quizFeedback = null;

            let options = [];
            if (quizMode === 'en-to-zh') {
                const correct = selected.meanings.map(m => ({ text: m, isCorrect: true }));
                const wrong = wordList
                    .filter(w => w.word !== selected.word)
                    .flatMap(w => w.meanings)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 5)
                    .map(m => ({ text: m, isCorrect: false }));
                options = [...correct, ...wrong].sort(() => Math.random() - 0.5);
            } else {
                options = [{ text: selected.word, isCorrect: true }];
                const used = new Set([selected.word]);
                const candidates = [...wordList].sort(() => Math.random() - 0.5);
                for(let w of candidates) {
                    if(!used.has(w.word)) {
                        options.push({ text: w.word, isCorrect: false });
                        used.add(w.word);
                    }
                    if(options.length >= 4) break;
                }
                options.sort(() => Math.random() - 0.5);
            }
            currentQuiz.options = options;
            renderQuiz();

            if (currentUser) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'words', selected.id), {
                    quizCount: (selected.quizCount || 0) + 1
                });
            }
        };

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Lab - 進階權重學習系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .nav-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <nav class="bg-white border-b sticky top-0 z-20 shadow-sm h-14">
        <div class="max-w-xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-1 font-black text-indigo-600 uppercase tracking-tighter">
                <i data-lucide="book-open" class="w-5 h-5"></i> <span>Eng Lab</span>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="switchTab('input')" id="btn-input" class="nav-btn active p-2 rounded-lg text-slate-400 hover:bg-slate-100"><i data-lucide="plus" class="w-5 h-5"></i></button>
                <button onclick="switchTab('list')" id="btn-list" class="nav-btn p-2 rounded-lg text-slate-400 hover:bg-slate-100"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
                <div class="w-px h-6 bg-slate-200"></div>
                <button onclick="startQuiz()" id="btn-quiz" class="nav-btn p-2 rounded-lg text-slate-400 hover:bg-slate-100"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-xl mx-auto p-4">
        <div id="view-input" class="view space-y-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 animate-in">
                <h2 class="text-xs font-bold mb-4 text-slate-400 uppercase tracking-widest">新增單字</h2>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <input id="word-name" type="text" class="flex-1 bg-slate-50 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500 font-bold" placeholder="輸入單字...">
                        <button onclick="autoTranslate()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 rounded-xl uppercase">Auto</button>
                    </div>
                    <div id="meanings-list" class="space-y-2">
                        <input type="text" class="meaning-input bg-slate-50 rounded-xl px-4 py-3 w-full outline-none" placeholder="輸入中文意思...">
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="addMeaningField()" class="text-xs font-bold text-indigo-600 flex items-center gap-1 hover:underline"><i data-lucide="plus" class="w-4 h-4"></i> 增加含義</button>
                        <select id="word-pos" class="text-xs font-bold text-slate-400 bg-transparent outline-none">
                            <option value="n.">n.</option><option value="v.">v.</option><option value="adj.">adj.</option><option value="adv.">adv.</option><option value="phr.">phr.</option>
                        </select>
                    </div>
                    <button onclick="saveWord()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black hover:bg-indigo-600 transition shadow-md uppercase">儲存</button>
                </div>
            </div>
        </div>

        <div id="view-list" class="view hidden space-y-3"><div class="relative"><i data-lucide="search" class="absolute left-4 top-3.5 text-slate-400 w-5 h-5"></i><input id="search-input" oninput="renderList()" type="text" placeholder="搜尋..." class="w-full pl-12 pr-4 py-3 bg-white rounded-xl border border-slate-100 shadow-sm outline-none"></div><div id="list-container" class="grid gap-2"></div></div>
        <div id="view-quiz" class="view hidden"><div id="quiz-card" class="p-8 rounded-3xl transition-all border-2 bg-white shadow-sm"></div></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'english-learning-v10';

        let user = null, words = [], currentQuiz = null, selectedChoices = [];

        onAuthStateChanged(auth, async (u) => {
            user = u;
            if (!u) {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
            } else {
                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'words'), (snap) => {
                    words = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderList();
                });
            }
        });

        window.switchTab = (tab) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'bg-indigo-600', 'text-white'));
            document.getElementById(`btn-${tab}`).classList.add('active', 'bg-indigo-600', 'text-white');
        };

        window.saveWord = async () => {
            const word = document.getElementById('word-name').value.trim().toLowerCase();
            const pos = document.getElementById('word-pos').value;
            const meanings = Array.from(document.querySelectorAll('.meaning-input')).map(i => i.value.trim()).filter(v => v !== '');
            if (!word || meanings.length === 0 || !user) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'words'), { word, meanings, pos, wrongCount: 0, quizCount: 0, createdAt: Date.now() });
            document.getElementById('word-name').value = '';
            document.getElementById('meanings-list').innerHTML = '<input type="text" class="meaning-input bg-slate-50 rounded-xl px-4 py-3 w-full outline-none" placeholder="輸入中文意思...">';
            switchTab('list');
        };

        window.addMeaningField = () => {
            const input = document.createElement('input');
            input.className = "meaning-input bg-slate-50 rounded-xl px-4 py-3 w-full outline-none mt-2 animate-in";
            input.placeholder = "輸入另一個意思...";
            document.getElementById('meanings-list').appendChild(input);
        };

        window.renderList = () => {
            const container = document.getElementById('list-container');
            const search = document.getElementById('search-input').value.toLowerCase();
            container.innerHTML = '';
            words.filter(w => w.word.includes(search)).forEach(w => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm";
                div.innerHTML = `<div><div class="flex items-center gap-2 font-black">${w.word} <span class="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded uppercase">${w.pos}</span></div><div class="text-xs text-slate-500">${w.meanings.join(', ')}</div></div><button onclick="deleteWord('${w.id}')" class="text-slate-300 hover:text-rose-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        };

        window.deleteWord = async (id) => { if(confirm("刪除？")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'words', id)); };

        // --- 加權抽題核心邏輯 ---
        window.startQuiz = () => {
            if (words.length < 4) return alert("請至少加入 4 個單字");
            switchTab('quiz');
            
            // 1. 篩選：找出測驗次數偏低的單字群組 (基礎權重)
            const minQuiz = Math.min(...words.map(w => w.quizCount || 0));
            const pool = words.filter(w => (w.quizCount || 0) <= minQuiz + 1);

            // 2. 加權：根據錯誤次數分配籤數 (核心權重)
            const weightedPool = [];
            pool.forEach(w => {
                const tickets = (w.wrongCount || 0) + 1; // 錯愈多，籤愈多
                for(let i=0; i<tickets; i++) weightedPool.push(w);
            });

            const target = weightedPool[Math.floor(Math.random() * weightedPool.length)];
            const mode = Math.random() > 0.5 ? 'en-to-zh' : 'zh-to-en';
            let options = [];

            if (mode === 'en-to-zh') {
                const corrects = target.meanings.map(m => ({ text: m, isCorrect: true }));
                const wrongs = words.filter(w => w.word !== target.word).flatMap(w => w.meanings).sort(() => 0.5 - Math.random()).slice(0, 4).map(m => ({ text: m, isCorrect: false }));
                options = [...corrects, ...wrongs].sort(() => 0.5 - Math.random());
            } else {
                // 中翻英：防重複單字選項
                options = [{ text: target.word, isCorrect: true }];
                const used = new Set([target.word]);
                const shuffled = [...words].sort(() => 0.5 - Math.random());
                for(let c of shuffled) { if(!used.has(c.word)) { options.push({ text: c.word, isCorrect: false }); used.add(c.word); } if(options.length >= 4) break; }
                options.sort(() => 0.5 - Math.random());
            }

            currentQuiz = { ...target, options, mode };
            selectedChoices = [];
            renderQuizCard();
        };

        const renderQuizCard = () => {
            const card = document.getElementById('quiz-card');
            const isMulti = currentQuiz.mode === 'en-to-zh' && currentQuiz.meanings.length > 1;
            card.className = "p-8 rounded-3xl transition-all border-2 bg-white shadow-sm";
            card.innerHTML = `<div class="text-center mb-8"><span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[10px] font-black uppercase tracking-widest mb-2 inline-block">詞性：${currentQuiz.pos}</span><h2 class="text-4xl font-black text-slate-900 mt-2">${currentQuiz.mode === 'en-to-zh' ? currentQuiz.word : currentQuiz.meanings[0]}</h2><p class="text-[10px] text-slate-400 mt-3 font-bold uppercase">${isMulti ? '多選題：選出所有正確含義' : '單選題：選擇正確答案'}</p></div><div class="grid gap-3 max-w-sm mx-auto" id="quiz-options"></div><button onclick="checkAnswer()" id="check-btn" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black mt-6 disabled:opacity-50" disabled>確認提交</button>`;
            const optContainer = document.getElementById('quiz-options');
            currentQuiz.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "opt-btn w-full p-4 rounded-xl text-left font-bold border border-slate-100 flex items-center gap-4 transition-all";
                btn.innerHTML = `<div class="opacity-30 text-xs">${idx + 1}</div><span class="truncate">${opt.text}</span>`;
                btn.onclick = () => {
                    if (isMulti) { if (selectedChoices.includes(opt.text)) selectedChoices = selectedChoices.filter(s => s !== opt.text); else selectedChoices.push(opt.text); }
                    else { selectedChoices = [opt.text]; document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50')); }
                    btn.classList.toggle('ring-2', selectedChoices.includes(opt.text));
                    btn.classList.toggle('ring-indigo-500', selectedChoices.includes(opt.text));
                    btn.classList.toggle('bg-indigo-50', selectedChoices.includes(opt.text));
                    document.getElementById('check-btn').disabled = selectedChoices.length === 0;
                };
                optContainer.appendChild(btn);
            });
        };

        window.checkAnswer = async () => {
            const corrects = currentQuiz.options.filter(o => o.isCorrect).map(o => o.text);
            const isPerfect = selectedChoices.length === corrects.length && selectedChoices.every(s => corrects.includes(s));
            const card = document.getElementById('quiz-card');
            card.classList.add(isPerfect ? 'bg-emerald-50' : 'bg-rose-50');
            card.classList.add(isPerfect ? 'border-emerald-300' : 'border-rose-300');
            document.querySelectorAll('.opt-btn').forEach(btn => {
                const text = btn.querySelector('span').innerText;
                if (corrects.includes(text)) btn.className = "w-full p-4 rounded-xl text-left font-bold border bg-emerald-500 text-white flex items-center gap-4";
                else if (selectedChoices.includes(text)) btn.className = "w-full p-4 rounded-xl text-left font-bold border bg-rose-500 text-white flex items-center gap-4";
                else btn.style.opacity = "0.3";
            });
            const footer = document.createElement('div');
            footer.className = "mt-6 text-center animate-in";
            footer.innerHTML = `<div class="text-sm font-black mb-4 ${isPerfect ? 'text-emerald-600' : 'text-rose-600'}">${isPerfect ? '完全正確！' : '不正確，正確含義：' + currentQuiz.meanings.join(', ')}</div><button onclick="startQuiz()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black shadow-lg">下一題</button>`;
            card.querySelector('#check-btn').remove(); card.appendChild(footer);
            if (user) {
                const updateData = { quizCount: (currentQuiz.quizCount || 0) + 1 };
                if (!isPerfect) updateData.wrongCount = (currentQuiz.wrongCount || 0) + 1;
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'words', currentQuiz.id), updateData);
            }
        };

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>
